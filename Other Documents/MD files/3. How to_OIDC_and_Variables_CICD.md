## **1.	Download git and clone IAM-ROLE-GITHUBACTION(Directory) from the repository to local computer:**

```bash
    sudo apt update
    sudo apt install git -y 
    git clone --depth 1 https://github.com/Carlo-05/CI-CD-Github-Actions-Terraform-Project.git
    cd CI-CD-Github-Actions-Terraform-Project/
    mv "Other Documents/IAM-ROLE-GITHUBACTION" ..
    cd ../
    rm -rf CI-CD-Github-Actions-Terraform-Project/
    ls
```
-   Example as shown in the image below:

    <div align="left">
    <img src="https://github.com/Carlo-05/CI-CD-Github-Actions-Terraform-Project/blob/main/Other%20Documents/Picture/IAM-ROLE-GITHUBACTION.png?raw=true" alt="OIDC"style="width: 60%; height: auto;">
    </div>

## **2.	Explore and review IAM-ROLE-GITHUBACTION:**
-	The directory contains main.tf, variables.tf, and output.tf.
-   Input the required information in the variables.tf as shown in the image:
    <div align="left">
    <img src="https://github.com/Carlo-05/CI-CD-Github-Actions-Terraform-Project/blob/main/Other%20Documents/Picture/HowTo_OIDC_variables-tf.png?raw=true" alt="OIDC"style="width: 40%; height: auto;">
    </div>
-   For more information about OIDC configuration for AWS, visit this [website](https://docs.github.com/en/actions/how-tos/secure-your-work/security-harden-deployments/oidc-in-aws).
-   As for the thumbprint used in the configuration. Here is the [link](https://github.blog/changelog/2022-01-13-github-actions-update-on-oidc-based-deployments-to-aws/).
    -   The OIDC thumbprint is the hashed identifier of the IdPâ€™s SSL certificate. It ensures AWS trusts only the genuine GitHub OIDC provider when exchanging tokens for temporary credentials.

## **3.	Proceed applying the configuration:**
-	Before running any terraform commands, make sure you are inside the IAM-ROLE-GITHUBACTION directory.
-   Initializes the IAM-ROLE-GITHUBACTION directory and downloads the required provider plugins by executing this code:
```bash
    terraform init
```
-   Once the configuration has been initialized, the next step is to provision the infrastructure:
```bash
    terraform apply -auto-approve
```
-   Take note of the output **IAM role arn**. We will use it for Github Action configuration.
## **4.	Proceed to create repository secret and environmental secrets:**
-	Navigate through your forked repository in Github.
    
    <div align="left">
    <img src="https://github.com/Carlo-05/CI-CD-Github-Actions-Terraform-Project/blob/main/Other%20Documents/Picture/Secrets%20and%20variables_1.png?raw=true" alt="SecretsAndVariables "style="width: 40%; height: auto;">
    </div>

-   Select **Actions** from Secrets and variables.

    <div align="left">
    <img src="https://github.com/Carlo-05/CI-CD-Github-Actions-Terraform-Project/blob/main/Other%20Documents/Picture/Secrets%20and%20variables_2.png?raw=true" alt="SecretsAndVariables "style="width: 40%; height: auto;">
    </div>

-   Create a **new repository secret**.
    -   **Repository secrets** are secure credentials shared by all workflows in a repository.

    <div align="left">
    <img src="https://github.com/Carlo-05/CI-CD-Github-Actions-Terraform-Project/blob/main/Other%20Documents/Picture/Secrets%20and%20variables_3.png?raw=true" alt="SecretsAndVariables "style="width: 40%; height: auto;">
    </div>

    -   Insert the **IAM-ROLE-GITHUBACTION arn** as the value of IAM_ROLE_ARN from number 3. 

    <div align="left">
    <img src="https://github.com/Carlo-05/CI-CD-Github-Actions-Terraform-Project/blob/main/Other%20Documents/Picture/Secrets%20and%20variables_4.png?raw=true" alt="SecretsAndVariables "style="width: 40%; height: auto;">
    </div>

-   Create environment secret next.
-   **Environment secrets** are environment-specific credentials with added security controls for development(dev) and production(prod) deployments.

    <div align="left">
    <img src="https://github.com/Carlo-05/CI-CD-Github-Actions-Terraform-Project/blob/main/Other%20Documents/Picture/Secrets%20and%20variables_5.png?raw=true" alt="SecretsAndVariables "style="width: 40%; height: auto;">
    </div>

-   In order to create a environment secret, let's make environment first. Let's start with **dev**. 

  
    <div align="left">
    <img src="https://github.com/Carlo-05/CI-CD-Github-Actions-Terraform-Project/blob/main/Other%20Documents/Picture/Secrets%20and%20variables_6.png?raw=true" alt="SecretsAndVariables "style="width: 40%; height: auto;">
    </div>

    <div align="left">
    <img src="https://github.com/Carlo-05/CI-CD-Github-Actions-Terraform-Project/blob/main/Other%20Documents/Picture/Secrets%20and%20variables_7.png?raw=true" alt="SecretsAndVariables "style="width: 40%; height: auto;">
    </div>

-   Once the environment **dev** is created, let's add secret for this environment.

    <div align="left">
    <img src="https://github.com/Carlo-05/CI-CD-Github-Actions-Terraform-Project/blob/main/Other%20Documents/Picture/Secrets%20and%20variables_8.png?raw=true" alt="SecretsAndVariables "style="width: 40%; height: auto;">
    </div>

-   Add public key that we created earlier. With this key, we can connect via ssh from local computer to aws resources that will be established.
-   Obtain the the value of the public key first. Input this code into the local terminal.
  
```bash
    cat ~/.ssh/id_rsa.pub
```
-   Output should look like the picture below:
  
    <div align="left">
    <img src="https://github.com/Carlo-05/CI-CD-Github-Actions-Terraform-Project/blob/main/Other%20Documents/Picture/Secrets%20and%20variables_9.png?raw=true" alt="SecretsAndVariables "style="width: 80%; height: auto;">
    </div>

-   Copy and paste the **value** of the public key into the environment secret **ID_RSA_PUBLIC**.

    <div align="left">
    <img src="https://github.com/Carlo-05/CI-CD-Github-Actions-Terraform-Project/blob/main/Other%20Documents/Picture/Secrets%20and%20variables_10.png?raw=true" alt="SecretsAndVariables "style="width: 40%; height: auto;">
    </div>

-   Add the RDS credentials from the SSM Parameter Store created before to the environment secret. Repeat the procedure for other secrets.

    <div align="left">
    <img src="https://github.com/Carlo-05/CI-CD-Github-Actions-Terraform-Project/blob/main/Other%20Documents/Picture/Secrets%20and%20variables_11.png?raw=true" alt="SecretsAndVariables "style="width: 40%; height: auto;">
    </div>

    -   For this project, I used this RDS credentials:
        ```bash
        #Parameter store
        ssm_db_name = /projectdb/database 
        ssm_db_username = /projectdb/username
        ssm_db_password = /projectdb/password
        ssm_db_endpoint = /projectdb/endpoint
        ```

### *Note: In GitHub Actions, the **names** of repository secrets, environment secrets, and repository/environment variables are normalized to uppercase. This means even if you define a variable name as ssm_db_name, GitHub will expose it as SSM_DB_NAME when injected into the runtime environment.* ###

-   Repeat the procedure of creating environment secrets for **prod** environment as well. The secrets are the same value as dev environment. See image below:

    <div align="left">
    <img src="https://github.com/Carlo-05/CI-CD-Github-Actions-Terraform-Project/blob/main/Other%20Documents/Picture/Secrets%20and%20variables_12.png?raw=true" alt="SecretsAndVariables "style="width: 40%; height: auto;">
    </div>

## **5. Create environment variables for dev and prod:**
-   Add environment variables.
    <div align="left">
    <img src="https://github.com/Carlo-05/CI-CD-Github-Actions-Terraform-Project/blob/main/Other%20Documents/Picture/Secrets%20and%20variables_13.png?raw=true" alt="SecretsAndVariables "style="width: 40%; height: auto;">
    </div>

    <div align="left">
    <img src="https://github.com/Carlo-05/CI-CD-Github-Actions-Terraform-Project/blob/main/Other%20Documents/Picture/Secrets%20and%20variables_14.png?raw=true" alt="SecretsAndVariables "style="width: 40%; height: auto;">
    </div>

-  ### **dev** ###
    ```bash

        # Github Actions Workflow variables
        AWS_REGION = us-west-2
        BACKEND_BUCKET = <Your S3 Bucket Name>
        BACKEND_KEY = GitHubActions/dev/terraform.tfstate
        BACKEND_REGION = us-west-2

        # VPC
        SELECT_REGION = west-2
        VPC_CIDR_BLOCK = 10.0.0.0/16
        PRIVATE_SUBNET_COUNt = 2
        PUBLIC_SUBNET_COUNT = 2

        # EC2 webapp
        SELECT_AMI = linux2 # choose between linux2(ec2-user) and ubuntu(ubuntu)
        INSTANCE_TYPE = t2.micro

        # Security Group
        CREATE_ASG_ALB_SG = false
        CREATE_BASTION_SG = false
        CREATE_WEBAPPINSTANCE_SG = true

        #RDS 
        DB_IDENTIFIER = projectdb
        DB_ENGINE = mysql
        DB_ENGINE_VERSION = 8.0
        DB_INSTANCE_CLASS = db.t3.micro #change to db.t3.medium for multi-az
        DB_ALLOCATED_STORAGE = 20
        DB_MULTI_AZ = false

        # TAGS
        #local tags
        ENV = dev
        PROJECT_NAME = cicd-GitHub-Action

        # Vpc tags
        VPC_TAG = MyVPC
        IGW_TAG = MyIgw
        PRIVATE_SUBNET_TAG = private
        PUBLIC_SUBNET_TAG = public
        PUBLIC_RT_TAG = public-rt
        PRIVATE_RT1_TAG = private-rt-1
        PRIVATE_RT2_TAG = private-rt-2

        # Security Group tags
        DBSG_TAG = dbsg-GitHub-Action
        ALB_SG_TAG = MyALB-sg
        ASG_SG_TAG = asg-sg
        WEBAPP_SG_TAG = Webappsg-GitHub-Action
        BASTION_SG_TAG = bastionsg-GitHub-Action

        #RDS tag
        DB_SUBNETGROUP_TAG = db-subnet-group-GitHub-Action

        # Iam role tag
        IAM_ROLE_TAG = GitHub-Action-role

        # Keypair tag
        KEYPAIR_TAG = GitHub-Action-key

        # EC2 WebApp Tag
        EC2_WEBAPP_TAG = webapp-GitHub-Action
        
    ```

-  ### **prod** ###
    ```bash

        # Github Actions Workflow variables
        AWS_REGION = us-west-2
        BACKEND_BUCKET = <Your S3 Bucket Name>
        BACKEND_KEY	= GitHubActions/prod/terraform.tfstate	
        BACKEND_REGION = us-west-2

        # VPC
        SELECT_REGION = west-2
        VPC_CIDR_BLOCK = 10.0.0.0/16
        PUBLIC_SUBNET_COUNT = 2
        PRIVATE_SUBNET_COUNT = 4

        # Security Group
        CREATE_ASG_ALB_SG = true
        CREATE_BASTION_SG = true
        CREATE_WEBAPPINSTANCE_SG = false

        #ALB
        S3_BUCKET_ALB_LOGS = <Your S3 Bucket Name>
        ALB_LOGS_PREFIX = prod-github-action

        #RDS 
        DB_IDENTIFIER = projectdb
        DB_ENGINE = mysql
        DB_ENGINE_VERSION = 8.0
        DB_INSTANCE_CLASS = db.t3.medium #change to db.t3.medium for multi-az. db.t3.micro for single instance
        DB_ALLOCATED_STORAGE = 20
        DB_MULTI_AZ = true

        # EC2 webapp/bastion/vault/ASG 
        SELECT_AMI = ubuntu # choose between linux2(ec2-user) and ubuntu(ubuntu)
        INSTANCE_TYPE = t2.micro

        # TAGS
        #local tags
        ENV = prod
        PROJECT_NAME = cicd-GitHub-Action

        # VPC tags
        VPC_TAG = MyVPC
        IGW_TAG = MyIgw
        PUBLIC_SUBNET_TAG = public
        PRIVATE_SUBNET_TAG = private
        PUBLIC_RT_TAG = public-rt
        PRIVATE_RT1_TAG = private-rt-1
        PRIVATE_RT2_TAG = private-rt-2

        # Security Group tags
        DBSG_TAG = dbsg-GitHub-Action
        ALB_SG_TAG = MyALB-sg
        ASG_SG_TAG = asg-sg
        WEBAPP_SG_TAG = Webappsg-GitHub-Action
        BASTION_SG_TAG = bastionsg-GitHub-Action

        #RDS tags
        DB_SUBNETGROUP_TAG = db-subnet-group-GitHub-Action

        #NAT tags
        NATGATEWAY_TAG = MyNAT
        EIP_TAG = MyElasticIP

        # Iam role tag
        IAM_ROLE_TAG = GitHub-Action-role

        # Keypair tag
        KEYPAIR_TAG = GitHub-Action-key

        # ALB tags
        WEBAPP_ALB_TAG = MyALB-GitHub-Action
        WEBAPP_TARGET_GROUP_TAG = WebApp-TG-GitHub-Action
        ALB_LISTENER_TAG = ALB-Listener

        # ASG tags
        WEBAPP_ASG_TEMPLATE_TAG = WebApp-Template-GitHub-Action
        WEBAPP_ASG_TAG = WebApp-ASG-GitHub-Action

        # Bastion Host tags
        BASTION_TAG = bastionhost-GitHub-Action        
    ```
### ***Note: Make sure that you are in the correct environment (dev or prod).*** ###

-   The environments should looked like the image below:
    <div align="left">
    <img src="https://github.com/Carlo-05/CI-CD-Github-Actions-Terraform-Project/blob/main/Other%20Documents/Picture/Secrets%20and%20variables_15.png?raw=true" alt="SecretsAndVariables "style="width: 40%; height: auto;">
    </div>



